[state_vector]
U32 DV_ELEM_STATE @alias S
U64 DV_ELEM_CN_TIME @alias G
U8 DV_ELEM_FC_STARTUP_CTRL_MODE
U8 DV_ELEM_FC_HEALTH_CTRL_MODE
U8 DV_ELEM_FLUIDS_CTRL_MODE
U8 DV_ELEM_DN0_DESYNC_CTRL_MODE
U8 DV_ELEM_DN1_DESYNC_CTRL_MODE
U8 DV_ELEM_DN2_DESYNC_CTRL_MODE
U8 DV_ELEM_ABORT_CTRL_MODE
bool DV_ELEM_PROCEED_TO_FILL
bool DV_ELEM_ABORT
U8 DV_ELEM_CN_WATCHDOG_CTRL_MODE
U8 DV_ELEM_DN0_WATCHDOG_CTRL_MODE
U8 DV_ELEM_DN1_WATCHDOG_CTRL_MODE
U8 DV_ELEM_DN2_WATCHDOG_CTRL_MODE
U8 DV_ELEM_GNC_CTRL_MODE
bool DV_ELEM_PROCEED_TO_TERM_CNT
bool DV_ELEM_BURN_BABY_BURN
U8 DV_ELEM_CN_LOGGING_CTRL_MODE
U8 DV_ELEM_DN0_LOGGING_CTRL_MODE
U8 DV_ELEM_DN1_LOGGING_CTRL_MODE
U8 DV_ELEM_DN2_LOGGING_CTRL_MODE
U8 DV_ELEM_ENGINE_CTRL_MODE
U8 DV_ELEM_CMD
bool DV_ELEM_PROCEED_TO_LAUNCH
bool DV_ELEM_LIFTOFF_CONFIRMED
U8 DV_ELEM_NCONE_CTRL_MODE_PRI
U8 DV_ELEM_DROGP_DEP_CTRL_MODE_PRI
U8 DV_ELEM_MAINP_CTRL_MODE_PRI
U8 DV_ELEM_NCONE_CTRL_MODE_BAK
U8 DV_ELEM_DROGP_DEP_CTRL_MODE_BAK
U8 DV_ELEM_MAINP_CTRL_MODE_BAK
U8 DV_ELEM_MTIME_CTRL_MODE
bool DV_ELEM_APOGEE
F64 DV_ELEM_ROCKET_POS_X
bool DV_ELEM_TOUCHDOWN

[local]
U8 MODE_SAFED = 0 @read_only
U8 MODE_ENABLED = 1 @read_only
U8 CMD_PROCEED = 4 @read_only
F64 MIN_APOGEE_FOR_RECOVERY_M = 2400 @read_only

[STATE_STARTUP]
.entry
    DV_ELEM_FC_STARTUP_CTRL_MODE = MODE_ENABLED
    DV_ELEM_FC_HEALTH_CTRL_MODE = MODE_ENABLED
    DV_ELEM_FLUIDS_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN0_DESYNC_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN1_DESYNC_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN2_DESYNC_CTRL_MODE = MODE_ENABLED
    DV_ELEM_ABORT_CTRL_MODE = MODE_ENABLED
.step
    DV_ELEM_PROCEED_TO_FILL: -> STATE_FILL
    DV_ELEM_ABORT: -> STATE_PRELAUNCH_ABORT

[STATE_FILL]
.entry
    DV_ELEM_FC_STARTUP_CTRL_MODE = MODE_SAFED
    DV_ELEM_CN_WATCHDOG_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN0_WATCHDOG_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN1_WATCHDOG_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN2_WATCHDOG_CTRL_MODE = MODE_ENABLED
    DV_ELEM_GNC_CTRL_MODE = MODE_ENABLED
.step
    DV_ELEM_PROCEED_TO_TERM_CNT: -> STATE_TERMINAL_COUNT
    DV_ELEM_ABORT: -> STATE_PRELAUNCH_ABORT

[STATE_PRELAUNCH_ABORT]
.entry
    DV_ELEM_PROCEED_TO_FILL = false
    DV_ELEM_PROCEED_TO_TERM_CNT = false
    DV_ELEM_ABORT = false
    DV_ELEM_BURN_BABY_BURN = false
    DV_ELEM_CN_LOGGING_CTRL_MODE = MODE_SAFED
    DV_ELEM_DN0_LOGGING_CTRL_MODE = MODE_SAFED
    DV_ELEM_DN1_LOGGING_CTRL_MODE = MODE_SAFED
    DV_ELEM_DN2_LOGGING_CTRL_MODE = MODE_SAFED
.step
    DV_ELEM_CMD == CMD_PROCEED: -> STATE_FILL
    DV_ELEM_ABORT: -> STATE_PRELAUNCH_ABORT_NO_GC

[STATE_PRELAUNCH_ABORT_NO_GC]
.step
    DV_ELEM_CMD == CMD_PROCEED: -> STATE_PRELAUNCH_ABORT

[STATE_TERMINAL_COUNT]
.step
    DV_ELEM_PROCEED_TO_LAUNCH: -> STATE_LAUNCH
    DV_ELEM_ABORT: -> STATE_PRELAUNCH_ABORT

[STATE_LAUNCH]
.entry
    DV_ELEM_CN_LOGGING_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN0_LOGGING_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN1_LOGGING_CTRL_MODE = MODE_ENABLED
    DV_ELEM_DN2_LOGGING_CTRL_MODE = MODE_ENABLED
.step
    DV_ELEM_LIFTOFF_CONFIRMED: -> STATE_POWERED_FLIGHT
    DV_ELEM_ABORT: -> STATE_PRELAUNCH_ABORT

[STATE_POWERED_FLIGHT]
.entry
    DV_ELEM_NCONE_CTRL_MODE_PRI = MODE_ENABLED
    DV_ELEM_DROGP_DEP_CTRL_MODE_PRI = MODE_ENABLED
    DV_ELEM_MAINP_CTRL_MODE_PRI = MODE_ENABLED
    DV_ELEM_NCONE_CTRL_MODE_BAK = MODE_ENABLED
    DV_ELEM_DROGP_DEP_CTRL_MODE_BAK = MODE_ENABLED
    DV_ELEM_MAINP_CTRL_MODE_BAK = MODE_ENABLED
    DV_ELEM_MTIME_CTRL_MODE = MODE_ENABLED
.step
    !DV_ELEM_BURN_BABY_BURN: -> STATE_COAST

[STATE_COAST]
.step
    DV_ELEM_APOGEE: -> STATE_APOGEE

[STATE_APOGEE]
.step
    DV_ELEM_ROCKET_POS_X < MIN_APOGEE_FOR_RECOVERY_M: -> STATE_GOODBYE
    DV_ELEM_ROCKET_POS_X >= MIN_APOGEE_FOR_RECOVERY_M: -> STATE_DESCENT

[STATE_GOODBYE]
.entry
    DV_ELEM_GNC_CTRL_MODE = MODE_SAFED
    DV_ELEM_NCONE_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_DROGP_DEP_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_MAINP_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_NCONE_CTRL_MODE_BAK = MODE_SAFED
    DV_ELEM_DROGP_DEP_CTRL_MODE_BAK = MODE_SAFED
    DV_ELEM_MAINP_CTRL_MODE_BAK = MODE_SAFED

[STATE_DESCENT]
.step
    DV_ELEM_TOUCHDOWN: -> STATE_TOUCHDOWN

[STATE_TOUCHDOWN]
.entry
    DV_ELEM_NCONE_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_DROGP_DEP_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_MAINP_CTRL_MODE_PRI = MODE_SAFED
    DV_ELEM_NCONE_CTRL_MODE_BAK = MODE_SAFED
    DV_ELEM_DROGP_DEP_CTRL_MODE_BAK = MODE_SAFED
    DV_ELEM_MAINP_CTRL_MODE_BAK = MODE_SAFED
    DV_ELEM_MTIME_CTRL_MODE = MODE_SAFED
